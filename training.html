<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>トレーニングお助けBOT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>
<div class="container">
<py-script>
 from flask import Flask, request, jsonify, render_template, send_from_directory
import pandas as pd
import re
import os

app = Flask(__name__, static_folder='static')

def load_data():
    df = pd.read_excel("トレ内容（改変済み）.xlsx")
    sheets = pd.read_excel("トレ内容（改変済み）.xlsx", sheet_name=None)


    difficulty_map = {
        "初級": "beginner",
        "中級": "intermediate",
        "上級": "advanced"
    }

    target_area_keywords = {
        "arms": [ "腕"],
        "chest": ["胸"],
        "back": ["背筋"],
        "abs": ["お腹"],
        "legs": ["足"],
        "shoulders": ["肩", "肩とれ"],
        "full-body": ["全身"]
    }

    def classify_duration(title):
        match = re.search(r"(\d+)\s*分", title)
        if match:
            minutes = int(match.group(1))
            if minutes <= 15:
                return "short"
            elif minutes <= 30:
                return "medium"
            else:
                return "long"
        return "all"

    def detect_target_area(title):
        for area, keywords in target_area_keywords.items():
            if any(kw in title for kw in keywords):
                return area
        return "full-body"

    df["difficulty"] = df["レベル"].map(difficulty_map).fillna("all")
    df["duration"] = df["タイトル"].apply(classify_duration)
    df["target_area"] = df["タイトル"].apply(detect_target_area)
    return df

# データをロード
df = load_data()

# トップページ：training.html を表示
@app.route("/")
def index():
    return render_template("training.html")

# 検索API：条件に合うトレーニングをJSONで返す
@app.route("/search", methods=["POST"])
def search():
    data = request.get_json()
    area = data.get("target_area", "all")
    difficulty = data.get("difficulty", "all")
    duration = data.get("duration", "all")

    result_df = df.copy()
    if area != "all":
        result_df = result_df[result_df["target_area"] == area]
    if difficulty != "all":
        result_df = result_df[result_df["difficulty"] == difficulty]
    if duration != "all":
        result_df = result_df[result_df["duration"] == duration]

    result = result_df[["タイトル", "URL", "difficulty", "duration", "target_area"]]
    return jsonify(result.to_dict(orient="records"))

# 静的ファイルの提供（style.css）
@app.route("/static/<path:filename>")
def static_files(filename):
    return send_from_directory("static", filename)

if __name__ == "__main__":
    app.run(debug=True)
</py-script>

    <header>
        <h1>トレーニングお助けBOT</h1>
        <p>あなたに合ったトレーニング動画を見つけましょう！</p>
    </header>

    <form id="filter-form">
        <div class="form-group">
            <label for="target-area">鍛えたい部位:</label>
            <select id="target-area" name="target-area">
                <option value="all">すべて</option>
                <option value="arms">腕</option>
                <option value="chest">胸</option>
                <option value="back">背中</option>
                <option value="abs">腹筋</option>
                <option value="legs">脚</option>
                <option value="shoulders">肩</option>
                
            </select>
        </div>

        <div class="form-group">
            <label for="difficulty">難易度:</label>
            <select id="difficulty" name="difficulty">
                <option value="all">すべて</option>
                <option value="beginner">初心者</option>
                <option value="intermediate">中級者</option>
                <option value="advanced">上級者</option>
            </select>
        </div>

        <div class="form-group">
            <label for="duration">時間:</label>
            <select id="duration" name="duration">
                <option value="all">すべて</option>
                <option value="short">15分以下</option>
                <option value="medium">15分以上</option>
            </select>
        </div>

        <button type="button" onclick="applyFilter()">フィルターを適用</button>
    </form>

    <section id="results" class="video-list"></section>
</div>

<script>
function applyFilter() {
    const targetArea = document.getElementById("target-area").value;
    const difficulty = document.getElementById("difficulty").value;
    const duration = document.getElementById("duration").value;

    fetch("/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            target_area: targetArea,
            difficulty: difficulty,
            duration: duration
        })
    })
    .then(res => res.json())
    .then(data => {
        const resultSection = document.getElementById("results");
        resultSection.innerHTML = "";

        if (data.length === 0) {
            resultSection.innerHTML = "<p class='alert alert-warning'>条件に合うトレーニングが見つかりませんでした。</p>";
            return;
        }

        data.forEach(item => {
            const card = document.createElement("div");
            card.className = "video-item fade-in";
            card.innerHTML = `
                <div class="video-thumbnail"></div>
                <div class="video-info">
                    <h3><a href="${item.URL}" target="_blank">${item.タイトル}</a></h3>
                    <div class="video-meta">
                        <span class="video-level">難易度: ${item.difficulty}</span>
                        <span class="video-duration">時間: ${item.duration}</span>
                    </div>
                    <p>部位: ${item.target_area}</p>
                </div>
            `;
            resultSection.appendChild(card);
        });
    })
    .catch(error => {
        console.error("検索エラー:", error);
    });
}
</script>
</body>
</html>
